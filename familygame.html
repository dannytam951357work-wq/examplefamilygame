<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>é é˜²å®¶æš´ï¼šæƒ…å¢ƒè²¼ç´™å°éŠæˆ²</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#121a33;
      --text:#f3f6ff;
      --muted:#b8c0de;
      --accent:#7aa2ff;
      --good:#2de2a6;
      --warn:#ffd166;
      --bad:#ff5c7a;
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Arial, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      background:
        radial-gradient(1000px 600px at 20% 10%, rgba(122,162,255,.25), transparent 50%),
        radial-gradient(900px 600px at 80% 30%, rgba(45,226,166,.18), transparent 50%),
        radial-gradient(900px 600px at 30% 90%, rgba(255,92,122,.15), transparent 55%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .app{
      width:min(980px, 100%);
      display:grid;
      grid-template-rows:auto 1fr auto;
      gap:14px;
    }
    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding:16px 18px;
      border-radius:var(--radius);
      background:rgba(18,26,51,.75);
      box-shadow:var(--shadow);
      border:1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(10px);
    }
    .titleWrap{ display:flex; flex-direction:column; gap:6px; }
    .title{
      font-size:18px;
      font-weight:800;
      letter-spacing:.5px;
    }
    .sub{
      font-size:13px;
      color:var(--muted);
      line-height:1.35;
    }
    .pillRow{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .pill{
      font-size:12px;
      padding:7px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color:var(--muted);
      user-select:none;
    }
    .pill strong{ color:var(--text); }

    main{
      display:grid;
      grid-template-rows: 1fr auto;
      gap:14px;
    }

    .sceneCard{
      background:rgba(18,26,51,.75);
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      position:relative;
      min-height: 360px;
      isolation: isolate; /* make z-index layers reliable */
    }

    /* âœ… Fix #1: ensure top bar is ABOVE everything */
    .sceneTopBar{
      position:absolute;
      inset: 0 0 auto 0;
      padding:12px 12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      z-index: 50; /* was missing */
      pointer-events:none;
    }
    .qBubble{
      pointer-events:none;
      display:flex;
      flex-direction:column;
      gap:6px;
      max-width: min(720px, 78%);
      padding:10px 12px;
      border-radius: 16px;
      background: rgba(0,0,0,.42);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
      backdrop-filter: blur(8px);
    }
    .qText{
      font-weight:900;
      font-size:16px;
      line-height:1.2;
      text-shadow: 0 2px 16px rgba(0,0,0,.5);
    }
    .hint{
      font-size:12px;
      color:rgba(243,246,255,.86);
      line-height:1.25;
    }
    .miniHint{
      pointer-events:none;
      font-size:12px;
      color:rgba(243,246,255,.80);
      padding:10px 12px;
      border-radius: 16px;
      background: rgba(0,0,0,.30);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 12px 40px rgba(0,0,0,.25);
      backdrop-filter: blur(8px);
      height: fit-content;
    }

    #dropZone{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index: 10;
    }

    .sceneImg{
      width:min(820px, 100%);
      aspect-ratio: 16/9;
      border-radius: 14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 18px 70px rgba(0,0,0,.35);
      position:relative;
      background:rgba(0,0,0,.15);
      touch-action: none;
    }

    /* âœ… Fix #2: feedback panel (non-fullscreen) */
    .feedbackPanel{
      position:absolute;
      top: 76px; /* below the top bar */
      right: 14px;
      width: 320px;
      max-width: calc(100% - 28px);
      border-radius: 18px;
      background: rgba(18,26,51,.92);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 24px 70px rgba(0,0,0,.55);
      backdrop-filter: blur(12px);
      z-index: 60;
      overflow:hidden;
      display:none;
    }
    .feedbackPanel.show{ display:block; }
    .fpHead{
      padding:12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:900;
      font-size:12px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      white-space:nowrap;
    }
    .bDot{ width:10px; height:10px; border-radius:999px; }
    .fpBody{
      padding:12px 12px;
      line-height:1.55;
      font-size:13.5px;
    }
    .fpTitle{
      font-weight:900;
      font-size:14.5px;
      margin-bottom:6px;
    }
    .fpTip{
      margin-top:10px;
      color: var(--muted);
      font-size:12.5px;
    }
    .fpFoot{
      padding:12px 12px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
      border-top:1px solid rgba(255,255,255,.10);
    }

    /* placed sticker */
    .placed{
      position:absolute;
      width: 120px;
      height: 120px;
      border-radius: 16px;
      box-shadow: 0 14px 30px rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.14);
      cursor:grab;
      user-select:none;
      touch-action:none;
      transform: translate(-50%, -50%);
      overflow:hidden;
      background:rgba(255,255,255,.08);
      backdrop-filter: blur(6px);
    }
    .placed:active{ cursor:grabbing; }
    .placed .miniLabel{
      position:absolute;
      inset:auto 8px 8px 8px;
      padding:6px 8px;
      border-radius:12px;
      font-size:12px;
      font-weight:800;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.14);
      text-shadow: 0 2px 12px rgba(0,0,0,.35);
    }

    .choices{
      background:rgba(18,26,51,.75);
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .choicesHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .choicesHeader .label{
      font-size:14px;
      color:var(--muted);
    }
    .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    button{
      appearance:none;
      border:0;
      cursor:pointer;
      border-radius: 14px;
      padding:10px 12px;
      font-weight:800;
      color:var(--text);
      background: rgba(122,162,255,.18);
      border:1px solid rgba(122,162,255,.35);
    }
    button:hover{ filter:brightness(1.08); }
    button.secondary{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color:var(--muted);
      font-weight:700;
    }

    .stickerRow{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    @media (max-width: 740px){
      .stickerRow{ grid-template-columns: 1fr; }
      .sceneCard{ min-height: 460px; }
      /* on mobile, feedback panel becomes bottom sheet-ish */
      .feedbackPanel{
        left: 14px;
        right: 14px;
        width: auto;
        top: auto;
        bottom: 14px;
      }
    }

    .sticker{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding:10px;
      display:flex;
      align-items:center;
      gap:10px;
      user-select:none;
      cursor:grab;
      touch-action:none;
    }
    .sticker:active{ cursor:grabbing; }
    .thumb{
      width:72px;
      height:72px;
      border-radius:14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 10px 22px rgba(0,0,0,.20);
      flex:0 0 auto;
      background: rgba(0,0,0,.10);
      display:flex; align-items:center; justify-content:center;
    }
    .sticker .meta{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .sticker .name{
      font-weight:900;
      font-size:14px;
      line-height:1.1;
    }
    .sticker .desc{
      font-size:12px;
      color:var(--muted);
      line-height:1.25;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      font-weight:900;
      padding:5px 8px;
      border-radius:999px;
      width:max-content;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      margin-top:3px;
    }
    .dot{
      width:8px; height:8px; border-radius:999px;
      background: var(--accent);
      box-shadow: 0 0 0 4px rgba(122,162,255,.15);
    }

    .endCard{
      padding:18px;
      display:none;
      flex-direction:column;
      gap:10px;
    }
    .endCard h2{ margin:0; font-size:18px; }
    .endCard p{ margin:0; color:var(--muted); line-height:1.5; }
    .hotline{
      margin-top:6px;
      padding:12px 12px;
      border-radius:16px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:13px;
    }
    .hotline strong{ color:var(--text); }
    .muted{ color:var(--muted); }
  </style>
</head>

<body>
  <div class="app">
    <header>
      <div class="titleWrap">
        <div class="title">é é˜²å®¶æš´ï¼šæƒ…å¢ƒè²¼ç´™å°éŠæˆ²</div>
        <div class="sub">
          æŠŠä¸‹æ–¹ã€Œå®¶é•·å›æ‡‰ã€æ‹–æ‹‰åˆ°ä¸Šæ–¹æƒ…å¢ƒåœ–ä¸­ä»»ä½•ä½ç½®ï¼Œå°±åƒè²¼ç´™ä¸€æ¨£è²¼ä¸Šå»ã€‚<br/>
          ï¼ˆè²¼ä¸Šå¾Œä»å¯æ‹–å‹•èª¿æ•´ä½ç½®ï¼›å¿«é€Ÿé€£æŒ‰å…©ä¸‹å¯ç§»é™¤ï¼‰
        </div>
      </div>
      <div class="pillRow">
        <div class="pill">é¡Œç›®ï¼š<strong id="qIndex">1</strong>/<strong id="qTotal">3</strong></div>
        <div class="pill">æ“ä½œï¼š<strong>æ‹–æ‹‰è²¼ç´™</strong></div>
      </div>
    </header>

    <main>
      <section class="sceneCard">
        <div class="sceneTopBar">
          <div class="qBubble">
            <div class="qText" id="questionText">å®¶é•·å¯æ€æ¨£æ‡‰ä»˜ï¼Ÿ</div>
            <div class="hint">æŠŠä½ è¦ºå¾—æœ€åˆé©çš„ã€Œå®¶é•·æ…‹åº¦ã€æ‹–åˆ°åœ–ä¸Šï¼ˆå¯æ”¾ä»»ä½•ä½ç½®ï¼‰</div>
          </div>
          <div class="miniHint">æç¤ºï¼šæ‹–æ‹‰è²¼ç´™ â†’ æ”¾æ‰‹è²¼ä¸Š</div>
        </div>

        <div id="dropZone">
          <div class="sceneImg" id="sceneImg" aria-label="æƒ…å¢ƒåœ–ç‰‡ï¼ˆæ”¾ç½®å€ï¼‰"></div>
        </div>

        <!-- âœ… Non-fullscreen feedback panel -->
        <aside class="feedbackPanel" id="feedbackPanel" aria-live="polite">
          <div class="fpHead">
            <div class="badge">
              <span class="bDot" id="bDot"></span>
              <span id="badgeText">å›é¥‹</span>
            </div>
            <button class="secondary" id="btnClosePanel" type="button">æ”¶èµ·</button>
          </div>
          <div class="fpBody">
            <div class="fpTitle" id="feedbackTitle"></div>
            <div id="feedbackBody"></div>
            <div class="fpTip" id="feedbackTip"></div>
          </div>
          <div class="fpFoot">
            <button class="secondary" id="btnKeep" type="button">å…ˆçœ‹çœ‹</button>
            <button id="btnPanelNext" type="button">ä¸‹ä¸€é¡Œ</button>
          </div>
        </aside>
      </section>

      <section class="choices">
        <div class="choicesHeader">
          <div class="label">é¸ä¸€å€‹å®¶é•·å›æ‡‰ï¼ˆå¯æ‹–æ‹‰ï¼‰</div>
          <div class="actions">
            <button class="secondary" id="btnReset" type="button">æ¸…é™¤è²¼ç´™</button>
            <button id="btnNext" type="button">ä¸‹ä¸€é¡Œ</button>
          </div>
        </div>

        <div class="stickerRow" id="stickerRow"></div>

        <div class="endCard" id="endCard">
          <h2>å®Œæˆï¼</h2>
          <p>è¬è¬ä½ å®Œæˆé€™å€‹å°éŠæˆ²ã€‚å®¶æš´ä¸æ˜¯å®¶äº‹ï¼Œæ˜¯éœ€è¦è¢«çœ‹è¦‹èˆ‡è¢«æ”¯æ´çš„è­°é¡Œã€‚</p>
          <div class="hotline">
            <div><strong>éœ€è¦å¹«åŠ©ï¼Ÿ</strong>å¦‚æœä½ æˆ–ä½ èº«é‚Šçš„äººæ­£è™•æ–¼å±éšªï¼Œè«‹ç«‹å³æ±‚åŠ©ã€‚</div>
            <div class="muted">
              â€» è«‹æŠŠä»¥ä¸‹å…§å®¹æ”¹æˆä½ è¡—ç«™è¦å±•ç¤ºçš„æ¾³é–€/æœ¬åœ°ç†±ç·šèˆ‡è³‡æºï¼ˆé€™è£¡å…ˆæ”¾ç¤ºä¾‹æ–‡å­—ï¼‰ã€‚
            </div>
            <div>ğŸ”¸ ç·Šæ€¥æƒ…æ³ï¼š<strong>è«‹è‡´é›»ç•¶åœ°ç·Šæ€¥æœå‹™</strong></div>
            <div>ğŸ”¸ å®¶æš´æ”¯æ´/ç¤¾æœƒæœå‹™ï¼š<strong>ï¼ˆè«‹å¡«å…¥æœ¬åœ°ç†±ç·šï¼‰</strong></div>
            <div>ğŸ”¸ ç¤¾å€ä¸­å¿ƒï¼š<strong>ï¼ˆè«‹å¡«å…¥ä¸­å¿ƒé›»è©±/åœ°å€ï¼‰</strong></div>
          </div>
          <div class="actions" style="margin-top:10px;">
            <button class="secondary" id="btnReplay" type="button">å†ç©ä¸€æ¬¡</button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    function svgDataUri(svgText){
      return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svgText.trim());
    }

    const SCENES = [
      {
        id: "crying-child",
        title: "å®¶é•·å¯æ€æ¨£æ‡‰ä»˜ï¼Ÿ",
        subtitle: "å­©å­åœ¨å“­æ³£ï¼Œåƒæ˜¯å—äº†å§”å±ˆæˆ–å®³æ€•ã€‚",
        svg: svgDataUri(`
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1600 900">
            <defs>
              <linearGradient id="g1" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0" stop-color="#23315f"/>
                <stop offset="1" stop-color="#111a33"/>
              </linearGradient>
              <linearGradient id="floor" x1="0" x2="1">
                <stop offset="0" stop-color="#1a2244"/>
                <stop offset="1" stop-color="#141c39"/>
              </linearGradient>
            </defs>
            <rect width="1600" height="900" fill="url(#g1)"/>
            <rect y="560" width="1600" height="340" fill="url(#floor)" opacity="0.95"/>
            <circle cx="260" cy="210" r="120" fill="#7aa2ff" opacity="0.18"/>
            <circle cx="1380" cy="240" r="150" fill="#2de2a6" opacity="0.12"/>
            <rect x="1180" y="120" width="320" height="240" rx="26" fill="rgba(255,255,255,0.06)" stroke="rgba(255,255,255,0.10)" stroke-width="6"/>
            <path d="M1180 240 H1500" stroke="rgba(255,255,255,0.10)" stroke-width="6"/>
            <path d="M1340 120 V360" stroke="rgba(255,255,255,0.10)" stroke-width="6"/>

            <g transform="translate(520,170)">
              <ellipse cx="280" cy="560" rx="300" ry="80" fill="rgba(0,0,0,0.35)"/>
              <rect x="170" y="320" width="220" height="220" rx="60" fill="rgba(255,255,255,0.06)" stroke="rgba(255,255,255,0.10)" stroke-width="6"/>
              <circle cx="280" cy="260" r="120" fill="#ffd9c9"/>
              <path d="M210 230 Q280 280 350 230" stroke="#1b2240" stroke-width="10" fill="none" opacity="0.5"/>
              <circle cx="240" cy="250" r="14" fill="#1b2240"/>
              <circle cx="320" cy="250" r="14" fill="#1b2240"/>
              <path d="M230 290 C220 315 225 335 245 360" stroke="#7aa2ff" stroke-width="10" fill="none" opacity="0.9"/>
              <path d="M330 290 C340 315 335 335 315 360" stroke="#7aa2ff" stroke-width="10" fill="none" opacity="0.9"/>
              <path d="M245 310 Q280 350 315 310" stroke="#ff5c7a" stroke-width="10" fill="none" stroke-linecap="round"/>
              <circle cx="190" cy="430" r="40" fill="#ffd9c9"/>
              <circle cx="370" cy="430" r="40" fill="#ffd9c9"/>
            </g>
          </svg>
        `)
      },
      {
        id: "homework-argue",
        title: "å®¶é•·å¯æ€æ¨£å›æ‡‰ï¼Ÿ",
        subtitle: "å­©å­ä¸æƒ³åšåŠŸèª²ï¼Œé–‹å§‹é¬§æƒ…ç·’ã€‚",
        svg: svgDataUri(`
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1600 900">
            <defs>
              <linearGradient id="g2" x1="0" x2="1">
                <stop offset="0" stop-color="#1a2a4e"/>
                <stop offset="1" stop-color="#101a33"/>
              </linearGradient>
            </defs>
            <rect width="1600" height="900" fill="url(#g2)"/>
            <rect y="580" width="1600" height="320" fill="rgba(255,255,255,0.04)"/>
            <rect x="330" y="520" width="940" height="80" rx="28" fill="rgba(255,255,255,0.08)" stroke="rgba(255,255,255,0.10)" stroke-width="6"/>
            <rect x="420" y="600" width="120" height="220" rx="26" fill="rgba(255,255,255,0.06)"/>
            <rect x="1060" y="600" width="120" height="220" rx="26" fill="rgba(255,255,255,0.06)"/>
            <g transform="translate(520,230)">
              <circle cx="280" cy="200" r="110" fill="#ffd9c9"/>
              <circle cx="240" cy="190" r="14" fill="#1b2240"/>
              <circle cx="320" cy="190" r="14" fill="#1b2240"/>
              <path d="M240 260 Q280 230 320 260" stroke="#ff5c7a" stroke-width="10" fill="none" stroke-linecap="round"/>
              <rect x="165" y="320" width="230" height="230" rx="60" fill="rgba(255,255,255,0.06)" stroke="rgba(255,255,255,0.10)" stroke-width="6"/>
              <rect x="90" y="420" width="160" height="90" rx="18" fill="rgba(122,162,255,0.22)" stroke="rgba(122,162,255,0.35)" stroke-width="6"/>
              <line x1="170" y1="420" x2="170" y2="510" stroke="rgba(255,255,255,0.20)" stroke-width="6"/>
            </g>
          </svg>
        `)
      },
      {
        id: "sibling-conflict",
        title: "å®¶é•·å¯æ€æ¨£è™•ç†ï¼Ÿ",
        subtitle: "å…©å€‹å­©å­çˆ­åµã€æ¨æ’ï¼Œæ°£æ°›å‡æº«ã€‚",
        svg: svgDataUri(`
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1600 900">
            <defs>
              <linearGradient id="g3" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0" stop-color="#20305c"/>
                <stop offset="1" stop-color="#0e1630"/>
              </linearGradient>
            </defs>
            <rect width="1600" height="900" fill="url(#g3)"/>
            <circle cx="260" cy="250" r="150" fill="#ff5c7a" opacity="0.10"/>
            <circle cx="1400" cy="220" r="170" fill="#2de2a6" opacity="0.10"/>
            <g transform="translate(380,210)">
              <circle cx="280" cy="200" r="105" fill="#ffd9c9"/>
              <circle cx="240" cy="190" r="14" fill="#1b2240"/>
              <circle cx="320" cy="190" r="14" fill="#1b2240"/>
              <path d="M240 250 Q280 280 320 250" stroke="#ff5c7a" stroke-width="10" fill="none" stroke-linecap="round"/>
              <rect x="170" y="320" width="220" height="240" rx="60" fill="rgba(255,255,255,0.06)" stroke="rgba(255,255,255,0.10)" stroke-width="6"/>
            </g>
            <g transform="translate(760,210)">
              <circle cx="280" cy="200" r="105" fill="#ffd9c9"/>
              <circle cx="240" cy="190" r="14" fill="#1b2240"/>
              <circle cx="320" cy="190" r="14" fill="#1b2240"/>
              <path d="M240 260 Q280 235 320 260" stroke="#ffd166" stroke-width="10" fill="none" stroke-linecap="round"/>
              <rect x="170" y="320" width="220" height="240" rx="60" fill="rgba(255,255,255,0.06)" stroke="rgba(255,255,255,0.10)" stroke-width="6"/>
            </g>
            <path d="M800 470 l60 -90" stroke="rgba(255,255,255,0.25)" stroke-width="8"/>
            <path d="M820 480 l90 -30" stroke="rgba(255,255,255,0.25)" stroke-width="8"/>
            <path d="M780 480 l-90 -30" stroke="rgba(255,255,255,0.25)" stroke-width="8"/>
          </svg>
        `)
      }
    ];

    const STICKERS = {
      calm: {
        key: "calm",
        name: "å®‰æ…°æºé€š",
        desc: "å…ˆå®‰æ’«æƒ…ç·’ï¼Œå†äº†è§£ç™¼ç”Ÿäº†ä»€éº¼ã€‚",
        tag: "è¼ƒåˆé©",
        dot: "#2de2a6",
        svg: svgDataUri(`
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200">
            <defs><linearGradient id="bg" x1="0" x2="1">
              <stop offset="0" stop-color="rgba(45,226,166,0.28)"/><stop offset="1" stop-color="rgba(122,162,255,0.22)"/>
            </linearGradient></defs>
            <rect width="200" height="200" rx="28" fill="url(#bg)"/>
            <circle cx="85" cy="85" r="34" fill="#ffd9c9"/>
            <circle cx="140" cy="90" r="34" fill="#ffd9c9"/>
            <circle cx="75" cy="82" r="6" fill="#1b2240"/>
            <circle cx="95" cy="82" r="6" fill="#1b2240"/>
            <path d="M74 97 Q85 107 96 97" stroke="#ff5c7a" stroke-width="6" fill="none" stroke-linecap="round"/>
            <circle cx="130" cy="87" r="6" fill="#1b2240"/>
            <circle cx="150" cy="87" r="6" fill="#1b2240"/>
            <path d="M129 102 Q140 112 151 102" stroke="#ff5c7a" stroke-width="6" fill="none" stroke-linecap="round"/>
            <path d="M115 130 C95 160 75 160 55 140" stroke="rgba(255,255,255,0.55)" stroke-width="8" fill="none" stroke-linecap="round"/>
            <path d="M120 130 C140 160 160 160 180 140" stroke="rgba(255,255,255,0.55)" stroke-width="8" fill="none" stroke-linecap="round"/>
          </svg>
        `)
      },
      anger: {
        key: "anger",
        name: "æ†¤æ€’ç™¼ç«",
        desc: "å¤§è²è²¬ç½µã€å¨åš‡ï¼Œæƒ…ç·’å¤±æ§ã€‚",
        tag: "é«˜é¢¨éšª",
        dot: "#ff5c7a",
        svg: svgDataUri(`
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200">
            <defs><linearGradient id="bg2" x1="0" x2="1">
              <stop offset="0" stop-color="rgba(255,92,122,0.26)"/><stop offset="1" stop-color="rgba(255,209,102,0.16)"/>
            </linearGradient></defs>
            <rect width="200" height="200" rx="28" fill="url(#bg2)"/>
            <circle cx="100" cy="92" r="55" fill="#ffd9c9"/>
            <path d="M64 80 l28 -10" stroke="#1b2240" stroke-width="10" stroke-linecap="round"/>
            <path d="M136 80 l-28 -10" stroke="#1b2240" stroke-width="10" stroke-linecap="round"/>
            <circle cx="80" cy="96" r="7" fill="#1b2240"/>
            <circle cx="120" cy="96" r="7" fill="#1b2240"/>
            <path d="M78 132 Q100 110 122 132" stroke="#ff5c7a" stroke-width="10" fill="none" stroke-linecap="round"/>
            <path d="M36 40 l22 18" stroke="#ffd166" stroke-width="8"/>
            <path d="M38 66 l24 -4" stroke="#ffd166" stroke-width="8"/>
            <path d="M164 40 l-22 18" stroke="#ffd166" stroke-width="8"/>
            <path d="M162 66 l-24 -4" stroke="#ffd166" stroke-width="8"/>
          </svg>
        `)
      },
      ignore: {
        key: "ignore",
        name: "å†·æ¼ å¿½è¦–",
        desc: "ä¸å›æ‡‰ã€ä¸Ÿä¸‹ä¸€å¥ã€Œä½ è‡ªå·±æƒ³è¾¦æ³•ã€ã€‚",
        tag: "å¯èƒ½å‚·å®³",
        dot: "#ffd166",
        svg: svgDataUri(`
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200">
            <defs><linearGradient id="bg3" x1="0" x2="1">
              <stop offset="0" stop-color="rgba(255,209,102,0.22)"/><stop offset="1" stop-color="rgba(255,255,255,0.06)"/>
            </linearGradient></defs>
            <rect width="200" height="200" rx="28" fill="url(#bg3)"/>
            <circle cx="92" cy="96" r="52" fill="#ffd9c9"/>
            <circle cx="76" cy="92" r="7" fill="#1b2240"/>
            <circle cx="108" cy="92" r="7" fill="#1b2240"/>
            <path d="M70 125 H114" stroke="#1b2240" stroke-width="10" stroke-linecap="round" opacity="0.6"/>
            <rect x="118" y="52" width="62" height="108" rx="18" fill="rgba(27,34,64,0.18)" stroke="rgba(255,255,255,0.18)" stroke-width="6"/>
            <circle cx="149" cy="138" r="6" fill="rgba(255,255,255,0.35)"/>
          </svg>
        `)
      }
    };

    const FEEDBACK = {
      "crying-child": {
        calm: { level:"good", title:"è¼ƒåˆé©ï¼šå…ˆå®‰æ’«ï¼Œå¾Œäº†è§£",
          body:"ç•¶å­©å­åœ¨å“­ï¼Œå…ˆç”¨æº«å’Œèªæ°£å®‰æ’«ï¼ˆä¾‹å¦‚ï¼šã€æˆ‘è¦‹åˆ°ä½ å¾ˆé›£å—ï¼Œæˆ‘åœ¨é€™è£¡ã€‚ã€ï¼‰ï¼Œå†äº†è§£åŸå› ã€‚é€™æœ‰åŠ©å­©å­é™æº«ï¼Œä¹Ÿé™ä½è¡çªå‡ç´šçš„é¢¨éšªã€‚",
          tip:"å¯ä»¥ç”¨ä¸€å¥ã€Œæˆ‘è½åˆ°ä½ ã€ï¼‹ä¸€å¥ã€Œæˆ‘å€‘ä¸€èµ·æƒ³è¾¦æ³•ã€ä¾†é–‹å§‹ã€‚" },
        anger:{ level:"bad", title:"é«˜é¢¨éšªï¼šè²¬ç½µ/å¨åš‡å®¹æ˜“å‡ç´š",
          body:"å¤§è²è²¬ç½µã€å¨åš‡å¯èƒ½ä»¤å­©å­æ›´å®³æ€•ï¼Œç”šè‡³æŠŠè¡çªæ¨å‘æ›´åš´é‡çš„è¨€èª/è‚¢é«”å‚·å®³ã€‚ç•¶ä½ æƒ…ç·’å‡æº«æ™‚ï¼Œå…ˆåœä¸€åœã€æ·±å‘¼å¸ã€å…ˆç¢ºä¿å®‰å…¨ã€‚",
          tip:"è‹¥ä½ å·²å¾ˆç”Ÿæ°£ï¼šå…ˆé›¢é–‹ 10â€“30 ç§’ã€æ”¾ä½éŸ³é‡ï¼Œå†å›ä¾†è™•ç†ã€‚" },
        ignore:{ level:"warn", title:"å¯èƒ½å‚·å®³ï¼šå¿½è¦–ä»¤å­©å­æ›´å­¤å–®",
          body:"å†·æ¼ å¿½è¦–æœƒä»¤å­©å­è¦ºå¾—ã€æˆ‘ä¸é‡è¦/æˆ‘ä¸è¢«ç†è§£ã€ï¼Œé•·é å¯èƒ½å½±éŸ¿è¦ªå­é—œä¿‚ï¼Œäº¦å¯èƒ½ä»¤æƒ…ç·’ç´¯ç©å¾Œçˆ†ç™¼ã€‚",
          tip:"å°±ç®—å¾ˆå¿™ï¼Œä¹Ÿå¯å…ˆèªªä¸€å¥ï¼šã€æˆ‘çœ‹åˆ°ä½ ä¸é–‹å¿ƒï¼Œæˆ‘æœƒåœ¨ 2 åˆ†é˜å¾Œé™ªä½ ã€‚ã€" }
      },
      "homework-argue": {
        calm:{ level:"good", title:"è¼ƒåˆé©ï¼šå…ˆå…±æƒ…ï¼‹è¨‚è¦çŸ©",
          body:"å­©å­æŠ—æ‹’åšåŠŸèª²ï¼Œå¯èƒ½å› ç‚ºå£“åŠ›å¤§æˆ–ä¸æ‡‚ã€‚å…ˆæ‰¿èªæ„Ÿå—ï¼ˆã€æˆ‘çŸ¥é“ä½ è¦ºå¾—å¾ˆé›£ã€ï¼‰ï¼Œå†ä¸€èµ·æ‹†ç´°ä»»å‹™ã€è¨‚çŸ­æ™‚é–“ç›®æ¨™ã€‚",
          tip:"ç”¨ã€Œ10 åˆ†é˜å°ç›®æ¨™ï¼‹1 åˆ†é˜ä¼‘æ¯ã€é€šå¸¸æ¯”å‚¬ä¿ƒæ›´æœ‰æ•ˆã€‚" },
        anger:{ level:"bad", title:"é«˜é¢¨éšªï¼šç”¨æ€’æ°£é€¼è¿«",
          body:"ç”¨æ€’æ°£é€¼è¿«å®¹æ˜“ä»¤å­©å­ä»¥ææ‡¼æœå¾ï¼Œé•·é å¯èƒ½é€ æˆæ›´å¤§æŠ—æ‹’æˆ–è¡çªå‡ç´šã€‚ç•¶ä½ è¦ºå¾—å¿ä¸ä½ï¼Œå…ˆæŠŠã€å®‰å…¨èˆ‡å°Šé‡ã€æ”¾åœ¨ç¬¬ä¸€ä½ã€‚",
          tip:"æŠŠå¥å¼ç”±ã€Œä½ å†å””åšæˆ‘å°±â€¦ã€æ”¹æˆã€Œæˆ‘éœ€è¦ä½ â€¦æˆ‘å€‘å¯ä»¥â€¦ã€ã€‚" },
        ignore:{ level:"warn", title:"å¯èƒ½å‚·å®³ï¼šæ”¾ä»»æœªå¿…æ˜¯æ”¾é¬†",
          body:"å®Œå…¨ä¸ç®¡å¯èƒ½ä»¤å­©å­æ›´é›£å»ºç«‹è¦å¾‹ï¼Œä¹Ÿå¯èƒ½ä»¤å•é¡Œç©ç´¯ã€‚å¯ä»¥ä¿æŒå¹³éœä½†æœ‰ç•Œç·šï¼šã€æˆ‘æœƒé™ªä½ é–‹å§‹ç¬¬ä¸€é¡Œã€‚ã€",
          tip:"æŠŠã€Œå¿½è¦–ã€æ”¹æˆã€ŒçŸ­æš«å†·éœï¼‹å›ä¾†é™ªä¼´ã€æœƒæ›´å¥½ã€‚" }
      },
      "sibling-conflict": {
        calm:{ level:"good", title:"è¼ƒåˆé©ï¼šå…ˆåˆ†é–‹ï¼‹æ•™è¡¨é”",
          body:"å…ˆæŠŠå…©å€‹å­©å­åˆ†é–‹ï¼ˆç¢ºä¿æ²’äººå—å‚·ï¼‰ï¼Œå†è¼ªæµè®“ä»–å€‘èªªç™¼ç”Ÿäº†ä»€éº¼ï¼Œæ•™ä»–å€‘ç”¨èªè¨€è¡¨é”éœ€è¦ï¼Œè€Œä¸æ˜¯ç”¨æ¨æ’è§£æ±ºã€‚",
          tip:"å¯ä»¥ç”¨ï¼šã€åœï¼å…ˆåˆ†é–‹ã€‚æ¯äººä¸€åˆ†é˜è¬›ã€‚ã€" },
        anger:{ level:"bad", title:"é«˜é¢¨éšªï¼šç”¨æ›´å¤§æš´åŠ›å£“ä½è¡çª",
          body:"å®¶é•·è‹¥ç”¨æåš‡æˆ–æ›´å¤§è²å£“åˆ¶ï¼Œå­©å­æœƒå­¸åˆ°ã€Œå¼·è€…è´ã€ã€‚é€™æœƒå¢åŠ æœªä¾†ç”¨æš´åŠ›è§£æ±ºå•é¡Œçš„æ©Ÿæœƒã€‚",
          tip:"å…ˆæŠŠè²ç·šæ”¾ä½ï¼Œåè€Œæ›´æœ‰åŠ›é‡ã€‚" },
        ignore:{ level:"warn", title:"å¯èƒ½å‚·å®³ï¼šä¸ä»‹å…¥æœƒè®“è¡çªå‡ç´š",
          body:"å­©å­æ¨æ’è‹¥ä¸ä»‹å…¥ï¼Œå¯èƒ½ç™¼å±•æˆå—å‚·æˆ–æ›´æ¿€çƒˆè¡çªã€‚å®¶é•·å¯ä»¥ä»‹å…¥ä½†ä¸åè¢’ï¼šå…ˆæ­¢æï¼Œå†è™•ç†å…¬å¹³è¦å‰‡ã€‚",
          tip:"é—œéµä¸æ˜¯ã€Œèª°å°èª°éŒ¯ã€ï¼Œè€Œæ˜¯ã€Œæ€æ¨£å®‰å…¨åœ°åœä¸‹ä¾†ã€ã€‚" }
      }
    };

    const state = { q: 0, placedCount: 0 };

    const sceneImg = document.getElementById("sceneImg");
    const questionText = document.getElementById("questionText");
    const stickerRow = document.getElementById("stickerRow");
    const qIndexEl = document.getElementById("qIndex");
    const qTotalEl = document.getElementById("qTotal");
    const btnNext = document.getElementById("btnNext");
    const btnReset = document.getElementById("btnReset");
    const endCard = document.getElementById("endCard");
    const btnReplay = document.getElementById("btnReplay");

    // panel
    const feedbackPanel = document.getElementById("feedbackPanel");
    const badgeText = document.getElementById("badgeText");
    const bDot = document.getElementById("bDot");
    const feedbackTitle = document.getElementById("feedbackTitle");
    const feedbackBody = document.getElementById("feedbackBody");
    const feedbackTip = document.getElementById("feedbackTip");
    const btnClosePanel = document.getElementById("btnClosePanel");
    const btnPanelNext = document.getElementById("btnPanelNext");
    const btnKeep = document.getElementById("btnKeep");

    qTotalEl.textContent = String(SCENES.length);

    function clearPlaced(){
      [...sceneImg.querySelectorAll(".placed")].forEach(el => el.remove());
      state.placedCount = 0;
      hidePanel();
    }

    function renderScene(){
      const scene = SCENES[state.q];
      qIndexEl.textContent = String(state.q + 1);
      questionText.textContent = scene.title;

      sceneImg.style.backgroundImage = `url('${scene.svg}')`;
      sceneImg.style.backgroundSize = "cover";
      sceneImg.style.backgroundPosition = "center";
      sceneImg.style.backgroundRepeat = "no-repeat";

      clearPlaced();
      endCard.style.display = "none";
      document.querySelector(".stickerRow").style.display = "";
      btnNext.style.display = "";
      btnReset.style.display = "";
    }

    function showEnd(){
      clearPlaced();
      endCard.style.display = "flex";
      document.querySelector(".stickerRow").style.display = "none";
      btnNext.style.display = "none";
      btnReset.style.display = "none";
    }

    function badgeForLevel(level){
      if(level === "good") return { text:"è¼ƒåˆé©", dot:"var(--good)" };
      if(level === "warn") return { text:"å¯èƒ½æœ‰é¢¨éšª", dot:"var(--warn)" };
      return { text:"é«˜é¢¨éšª", dot:"var(--bad)" };
    }

    function showPanel(sceneId, stickerKey){
      const pack = FEEDBACK[sceneId]?.[stickerKey];
      if(!pack) return;

      const b = badgeForLevel(pack.level);
      badgeText.textContent = b.text;
      bDot.style.background = b.dot;

      feedbackTitle.textContent = pack.title;
      feedbackBody.textContent = pack.body;
      feedbackTip.textContent = "å°æç¤ºï¼š" + pack.tip;

      feedbackPanel.classList.add("show");
    }

    function hidePanel(){
      feedbackPanel.classList.remove("show");
    }

    btnClosePanel.addEventListener("click", hidePanel);
    btnKeep.addEventListener("click", hidePanel);
    btnPanelNext.addEventListener("click", ()=>{
      hidePanel();
      nextQuestion();
    });

    btnNext.addEventListener("click", ()=> nextQuestion());
    btnReset.addEventListener("click", clearPlaced);

    function nextQuestion(){
      if(state.q < SCENES.length - 1){
        state.q += 1;
        renderScene();
      }else{
        showEnd();
      }
    }

    btnReplay?.addEventListener("click", ()=>{
      state.q = 0;
      renderScene();
    });

    const stickerOrder = ["anger","ignore","calm"];
    function renderStickers(){
      stickerRow.innerHTML = "";
      stickerOrder.forEach(key=>{
        const s = STICKERS[key];
        const el = document.createElement("div");
        el.className = "sticker";
        el.setAttribute("role","button");
        el.setAttribute("aria-label", s.name);

        el.innerHTML = `
          <div class="thumb">
            <img src="${s.svg}" alt="${s.name}" style="width:100%;height:100%;display:block;">
          </div>
          <div class="meta">
            <div class="name">${s.name}</div>
            <div class="desc">${s.desc}</div>
            <div class="tag"><span class="dot" style="background:${s.dot}; box-shadow:0 0 0 4px rgba(255,255,255,0.06)"></span>${s.tag}</div>
          </div>
        `;

        attachStickerDrag(el, key);
        stickerRow.appendChild(el);
      });
    }

    function attachStickerDrag(stickerEl, stickerKey){
      let dragging = false;
      let ghost = null;

      const onDown = (e)=>{
        e.preventDefault();
        dragging = true;

        ghost = document.createElement("div");
        ghost.style.position = "fixed";
        ghost.style.left = "-9999px";
        ghost.style.top = "-9999px";
        ghost.style.width = "120px";
        ghost.style.height = "120px";
        ghost.style.borderRadius = "16px";
        ghost.style.zIndex = "9999";
        ghost.style.pointerEvents = "none";
        ghost.style.boxShadow = "0 18px 40px rgba(0,0,0,.45)";
        ghost.style.border = "1px solid rgba(255,255,255,.14)";
        ghost.style.overflow = "hidden";
        ghost.innerHTML = `<img src="${STICKERS[stickerKey].svg}" style="width:100%;height:100%;display:block;" />`;
        document.body.appendChild(ghost);

        moveGhost(e);
        window.addEventListener("pointermove", onMove, {passive:false});
        window.addEventListener("pointerup", onUp, {passive:false});
      };

      const moveGhost = (e)=>{
        if(!ghost) return;
        ghost.style.left = (e.clientX - 60) + "px";
        ghost.style.top  = (e.clientY - 60) + "px";
        ghost.style.transform = "scale(1.02)";
      };

      const onMove = (e)=>{
        e.preventDefault();
        if(!dragging) return;
        moveGhost(e);
      };

      const onUp = (e)=>{
        e.preventDefault();
        if(!dragging) return;
        dragging = false;

        const dropped = tryPlaceSticker(e, stickerKey);

        if(ghost){ ghost.remove(); ghost = null; }
        window.removeEventListener("pointermove", onMove);
        window.removeEventListener("pointerup", onUp);

        if(dropped){
          const sceneId = SCENES[state.q].id;
          // âœ… show side panel, NOT fullscreen
          showPanel(sceneId, stickerKey);
        }
      };

      stickerEl.addEventListener("pointerdown", onDown, {passive:false});
    }

    function tryPlaceSticker(e, stickerKey){
      const rect = sceneImg.getBoundingClientRect();
      const x = e.clientX, y = e.clientY;

      if(x < rect.left || x > rect.right || y < rect.top || y > rect.bottom){
        return false;
      }

      const relX = ((x - rect.left) / rect.width) * 100;
      const relY = ((y - rect.top) / rect.height) * 100;

      const placed = document.createElement("div");
      placed.className = "placed";
      placed.style.left = relX + "%";
      placed.style.top  = relY + "%";
      placed.dataset.stickerKey = stickerKey;

      placed.innerHTML = `
        <img src="${STICKERS[stickerKey].svg}" alt="${STICKERS[stickerKey].name}" style="width:100%;height:100%;display:block;">
        <div class="miniLabel">${STICKERS[stickerKey].name}</div>
      `;

      sceneImg.appendChild(placed);
      makePlacedDraggable(placed);

      state.placedCount += 1;
      return true;
    }

    function makePlacedDraggable(el){
      let dragging = false;

      const onDown = (e)=>{
        e.preventDefault();
        dragging = true;
        el.setPointerCapture?.(e.pointerId);
        el.style.transform = "translate(-50%, -50%) scale(1.04)";
        window.addEventListener("pointermove", onMove, {passive:false});
        window.addEventListener("pointerup", onUp, {passive:false});
      };

      const onMove = (e)=>{
        e.preventDefault();
        if(!dragging) return;
        const rect = sceneImg.getBoundingClientRect();
        const x = Math.min(Math.max(e.clientX, rect.left), rect.right);
        const y = Math.min(Math.max(e.clientY, rect.top), rect.bottom);

        const relX = ((x - rect.left) / rect.width) * 100;
        const relY = ((y - rect.top) / rect.height) * 100;

        el.style.left = relX + "%";
        el.style.top  = relY + "%";
      };

      const onUp = (e)=>{
        e.preventDefault();
        dragging = false;
        el.style.transform = "translate(-50%, -50%) scale(1)";
        window.removeEventListener("pointermove", onMove);
        window.removeEventListener("pointerup", onUp);
      };

      let lastTap = 0;
      const onTap = ()=>{
        const now = Date.now();
        if(now - lastTap < 320){
          el.remove();
        }
        lastTap = now;
      };

      el.addEventListener("pointerdown", onDown, {passive:false});
      el.addEventListener("pointerup", onTap, {passive:true});
      el.title = "æ‹–å‹•å¯èª¿æ•´ä½ç½®ï¼›å¿«é€Ÿé€£æŒ‰å…©ä¸‹å¯ç§»é™¤";
    }

    renderStickers();
    renderScene();

    window.addEventListener("keydown", (e)=>{
      if(e.key.toLowerCase() === "n") nextQuestion();
      if(e.key.toLowerCase() === "r") clearPlaced();
      if(e.key === "Escape") hidePanel();
    });
  </script>
</body>
</html>
